# application-insights

This is an internal [Terraform](https://www.terraform.io/) module to create an [Application Insights ](https://learn.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview) instance in [Microsoft Azure](https://azure.microsoft.com/en-us).

This module supports:

- Creating an Application Insights instance
- Creating multiple standard web tests for each Application Insights instance (optional)
  - An Application Insights availability test automatically gets created for each standard web test
    - Option to attach an action group or multiple to the Application Insights availability test (optional)
- The ability to modify arguments for smart detection rules (all enabled by default) (optional)
  - Note: [Portal is suggesting to migrate to alert based smart detection rules but still in preview](https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-smart-detections-migration)

After deployment, retrieve the connection string of the Application Insights instance and use Ansible to install and link the agent by running the role located in: `2_Product_Platforms\ansible\roles\install_app_insights_agent`

The [auto-generated documentation](https://github.com/terraform-docs/terraform-docs) for this module is below.

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >=1.9.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >=4.3.0 |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | 4.3.0   |

## Examples

See the examples directory.

<!-- BEGIN_TF_DOCS -->

## Modules

No modules.

## Resources

| Name                                                                                                                                                                                | Type     |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_application_insights.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/application_insights)                                           | resource |
| [azurerm_application_insights_smart_detection_rule.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/application_insights_smart_detection_rule) | resource |
| [azurerm_application_insights_standard_web_test.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/application_insights_standard_web_test)       | resource |
| [azurerm_monitor_metric_alert.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_metric_alert)                                           | resource |

## Inputs

| Name                                                                                             | Description                                                                                                                                                                                                                                                                                                                                                                                        | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Default  | Required |
| ------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | :------: |
| <a name="input_action_group_id"></a> [action_group_id](#input_action_group_id)                   | List of action group IDs for alerts                                                                                                                                                                                                                                                                                                                                                                | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `[]`     |    no    |
| <a name="input_application_type"></a> [application_type](#input_application_type)                | Specifies the type of Application Insights to create. Valid values are ios for iOS, java for Java web, MobileCenter for App Center, Node.JS for Node.js, other for General, phone for Windows Phone, store for Windows Store and web for ASP.NET. Please note these values are case sensitive; unmatched values are treated as ASP.NET by Azure. Changing this forces a new resource to be created | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a      |   yes    |
| <a name="input_auto_mitigate"></a> [auto_mitigate](#input_auto_mitigate)                         | Should the alerts in this Metric Alert be auto resolved?                                                                                                                                                                                                                                                                                                                                           | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `true`   |    no    |
| <a name="input_daily_data_cap_in_gb"></a> [daily_data_cap_in_gb](#input_daily_data_cap_in_gb)    | Specifies the Application Insights component daily data volume cap in GB                                                                                                                                                                                                                                                                                                                           | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `100`    |    no    |
| <a name="input_enabled"></a> [enabled](#input_enabled)                                           | Should this Metric Alert be enabled?                                                                                                                                                                                                                                                                                                                                                               | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `true`   |    no    |
| <a name="input_failed_location_count"></a> [failed_location_count](#input_failed_location_count) | The number of failed locations                                                                                                                                                                                                                                                                                                                                                                     | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `1`      |    no    |
| <a name="input_frequency"></a> [frequency](#input_frequency)                                     | The evaluation frequency of this Metric Alert, represented in ISO 8601 duration format. Possible values are PT1M, PT5M, PT15M, PT30M and PT1H. Defaults to PT1M                                                                                                                                                                                                                                    | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"PT1M"` |    no    |
| <a name="input_location"></a> [location](#input_location)                                        | Location of the resource                                                                                                                                                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a      |   yes    |
| <a name="input_name"></a> [name](#input_name)                                                    | Name of the application insights                                                                                                                                                                                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a      |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name)       | Name of the resource group                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a      |   yes    |
| <a name="input_severity"></a> [severity](#input_severity)                                        | The severity of this Metric Alert. Possible values are 0, 1, 2, 3 and 4                                                                                                                                                                                                                                                                                                                            | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `3`      |    no    |
| <a name="input_smart_detection_rules"></a> [smart_detection_rules](#input_smart_detection_rules) | A list of smart detection rules                                                                                                                                                                                                                                                                                                                                                                    | <pre>list(object({<br/> name = string<br/> enabled = optional(bool, true)<br/> send_emails_to_subscription_owners = optional(bool, false)<br/> additional_email_recipients = optional(set(string))<br/> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`     |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                    | Tags of the Application Insights resource                                                                                                                                                                                                                                                                                                                                                          | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `{}`     |    no    |
| <a name="input_web_tests"></a> [web_tests](#input_web_tests)                                     | A list of web test configurations                                                                                                                                                                                                                                                                                                                                                                  | <pre>list(object({<br/> name = string<br/> description = string<br/> geo_locations = list(string) #https://learn.microsoft.com/en-us/previous-versions/azure/azure-monitor/app/monitor-web-app-availability#location-population-tags<br/> enabled = bool<br/> frequency = number<br/> retry_enabled = bool<br/> web_test_tags = map(string)<br/> timeout = number<br/> request = object({<br/> url = string<br/> body = optional(string)<br/> follow_redirects_enabled = optional(bool, true)<br/> http_verb = optional(string, "GET")<br/> parse_dependent_requests_enabled = optional(bool, true)<br/> headers = optional(list(object({<br/> name = string<br/> value = string<br/> })), [])<br/> })<br/> validation_rules = optional(object({<br/> expected_status_code = optional(number)<br/> ssl_cert_remaining_lifetime = optional(number)<br/> ssl_check_enabled = optional(bool)<br/> content_match = optional(string)<br/> ignore_case = optional(bool)<br/> pass_if_text_found = optional(bool)<br/> }), null)<br/> }))</pre> | `[]`     |    no    |
| <a name="input_window_size"></a> [window_size](#input_window_size)                               | The size of the time window to evaluate over                                                                                                                                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `"PT5M"` |    no    |
| <a name="input_workspace_id"></a> [workspace_id](#input_workspace_id)                            | ID of log analytics workspace                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n/a      |   yes    |

## Outputs

| Name                                                                                         | Description                                                |
| -------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| <a name="output_app_id"></a> [app_id](#output_app_id)                                        | App ID associated with this Application Insights component |
| <a name="output_connection_string"></a> [connection_string](#output_connection_string)       | Connection string for application insights                 |
| <a name="output_id"></a> [id](#output_id)                                                    | ID of the Application Insights component                   |
| <a name="output_instrumentation_key"></a> [instrumentation_key](#output_instrumentation_key) | Instrumentation key for application insights               |
| <a name="output_web_test_id"></a> [web_test_id](#output_web_test_id)                         | ID of the web test                                         |

<!-- END_TF_DOCS -->
