# `virtual-network`

This is an internal [Terraform](https://www.terraform.io/) module to create a [virtual network](https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview) in [Microsoft Azure](https://azure.microsoft.com/en-us).

This module supports:

- one to many subnets
- a [network security group (NSG)](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview) per subnet
- subnet delegation
- a route table

Note that if a route table is specified, it is assigned to all subnets. (If more granular functionality is needed in the future, this module can be expanded.)

The [auto-generated documentation](https://github.com/terraform-docs/terraform-docs) for this module is below.

## Examples

See the [examples](examples/README.md) directory.

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version    |
| ------------------------------------------------------------------------ | ---------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.9.0   |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | ~> 3.112.0 |

## Providers

| Name                                                         | Version    |
| ------------------------------------------------------------ | ---------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | ~> 3.112.0 |

## Modules

No modules.

## Resources

| Name                                                                                                                                                                                | Type     |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_network_security_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group)                                       | resource |
| [azurerm_route_table.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/route_table)                                                             | resource |
| [azurerm_subnet.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)                                                                       | resource |
| [azurerm_subnet_network_security_group_association.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_network_security_group_association) | resource |
| [azurerm_subnet_route_table_association.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_route_table_association)                       | resource |
| [azurerm_virtual_network.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network)                                                     | resource |
| [azurerm_virtual_network_peering.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network_peering)                                     | resource |

## Inputs

| Name                                                                        | Description                                                                                                                                                                                                                                                                                                                                           | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Default | Required |
| --------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | :------: |
| <a name="input_address_space"></a> [address_space](#input_address_space)    | Address space of the virtual network, e.g. `["10.0.0.0/8"]`                                                                                                                                                                                                                                                                                           | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | n/a     |   yes    |
| <a name="input_dns_servers"></a> [dns_servers](#input_dns_servers)          | List of custom DNS server IP addresses                                                                                                                                                                                                                                                                                                                | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `[]`    |    no    |
| <a name="input_environment"></a> [environment](#input_environment)          | Environment shortname                                                                                                                                                                                                                                                                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | n/a     |   yes    |
| <a name="input_location"></a> [location](#input_location)                   | Azure region short name (CAF). e.g. `eus` for East US. See: https://www.jlaundry.nz/2022/azure_region_abbreviations/                                                                                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | n/a     |   yes    |
| <a name="input_peerings"></a> [peerings](#input_peerings)                   | A map representing the other virtual networks that this virtual network will be peered to. Each key in the map should be equal to the name for the other virtual network. Each value in the map should be the object representing its peering configuration. This can be an empty object, which means the peering will use all of the default values. | <pre>map(object({<br> allow_virtual_network_access = optional(bool)<br> allow_forwarded_traffic = optional(bool)<br> allow_gateway_transit = optional(bool)<br> use_remote_gateways = optional(bool)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `{}`    |    no    |
| <a name="input_resource_group"></a> [resource_group](#input_resource_group) | Name of the resource group that this virtual network should be inside. Should be in the format of: `rg-foo`                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | n/a     |   yes    |
| <a name="input_route_table"></a> [route_table](#input_route_table)          | The route table that will be applied to every subnet. If no subnets are declared, then anything specified in this variable will be a no-op.                                                                                                                                                                                                           | <pre>object({<br> # If not specified, BGP route propagation will be enabled.<br> bgp_route_propagation_enabled = optional(bool)<br> # Map of routes and their properties. If this field is omitted, then the following default route<br> # will be applied:<br> # azure_firewall = {<br> # name = "udr-azfw"<br> # address_prefix = "0.0.0.0/0"<br> # next_hop_type = "VirtualAppliance"<br> # next_hop_in_ip_address = "10.120.0.68"<br> # }<br> routes = optional(map(object({<br> address_prefix = string<br> next_hop_type = string<br> # Only required when using: `next_hop_type = "VirtualAppliance"`<br> next_hop_in_ip_address = optional(string)<br> })))<br> })</pre> | `null`  |    no    |
| <a name="input_service_name"></a> [service_name](#input_service_name)       | The type of service that the network is for. Should be all lowercase and one word. e.g. `avd` (for Azure Virtual Desktop)                                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | n/a     |   yes    |
| <a name="input_subnets"></a> [subnets](#input_subnets)                      | Map of subnets and their properties                                                                                                                                                                                                                                                                                                                   | <pre>map(object({<br> address_prefix = string<br> service_endpoints = optional(list(string))<br> private_endpoint_network_policies = optional(string)<br> private_link_service_network_policies_enabled = optional(bool)<br> delegation = optional(object({<br> name = string<br> actions = list(string)<br> }))<br> nsg_rules = optional(list(object({<br> name = string<br> priority = number<br> direction = string<br> access = string<br> protocol = string<br> source_port_range = optional(string)<br> destination_port_range = optional(string)<br> source_address_prefix = optional(string)<br> destination_address_prefix = optional(string)<br> })))<br> }))</pre>    | `{}`    |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                               | Tags for the deployment. Tag names are case insensitive, but tag values are case sensitive. The `managedBy = "terraform"` tag will automatically be applied in addition to any other tags specified.                                                                                                                                                  | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `{}`    |    no    |

## Outputs

| Name                                                                                            | Description                             |
| ----------------------------------------------------------------------------------------------- | --------------------------------------- |
| <a name="output_nsg_output"></a> [nsg_output](#output_nsg_output)                               | Network security group                  |
| <a name="output_peering_ids"></a> [peering_ids](#output_peering_ids)                            | The IDs of the virtual network peerings |
| <a name="output_route_table_id"></a> [route_table_id](#output_route_table_id)                   | ID of the route table                   |
| <a name="output_route_table_name"></a> [route_table_name](#output_route_table_name)             | Name of the route table                 |
| <a name="output_virtual_network_id"></a> [virtual_network_id](#output_virtual_network_id)       | Virtual network ID                      |
| <a name="output_virtual_network_name"></a> [virtual_network_name](#output_virtual_network_name) | Virtual network name                    |

<!-- END_TF_DOCS -->
