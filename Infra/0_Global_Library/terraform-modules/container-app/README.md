# `container-app`

This is an internal [Terraform](https://www.terraform.io/) module to create a [Container App](https://learn.microsoft.com/en-us/azure/container-apps/overview) in [Microsoft Azure](https://azure.microsoft.com/en-us).

This module supports creating a Container app with:

- Multiple revisions and traffic weight distributed amongst revisions via ingress
- Connecting to Container registries with a user assigned identity( [when possible, you should use a user-assigned managed identity to pull images](https://learn.microsoft.com/en-us/azure/container-apps/managed-identity-image-pull?tabs=bash&pivots=portal) )
- Health Probes
- DAPR
<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >=1.9.0  |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >=4.14.0 |

## Providers

| Name                                                         | Version  |
| ------------------------------------------------------------ | -------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | >=4.14.0 |

## Modules

| Name                                                                                | Source              | Version |
| ----------------------------------------------------------------------------------- | ------------------- | ------- |
| <a name="module_common_constants"></a> [common_constants](#module_common_constants) | ../common/constants | n/a     |

## Resources

| Name                                                                                                                        | Type     |
| --------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_container_app.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_app) | resource |

## Inputs

| Name                                                                                                                  | Description                                                                                                                                                                                                                                                                                                                                     | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Default | Required |
| --------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | :------: |
| <a name="input_container_app_environment_id"></a> [container_app_environment_id](#input_container_app_environment_id) | The ID of the Container App Environment within which this Container App should exist. Changing this forces a new resource to be created                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_dapr"></a> [dapr](#input_dapr)                                                                         | Dapr configuration for the Container App                                                                                                                                                                                                                                                                                                        | <pre>object({<br/> app_id = string<br/> app_port = optional(number)<br/> app_protocol = optional(string)<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `null`  |    no    |
| <a name="input_environment"></a> [environment](#input_environment)                                                    | Environment shortname                                                                                                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_identity"></a> [identity](#input_identity)                                                             | Identity configuration for the Container App                                                                                                                                                                                                                                                                                                    | <pre>object({<br/> type = string<br/> identity_ids = optional(list(string))<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `null`  |    no    |
| <a name="input_ingress"></a> [ingress](#input_ingress)                                                                | Ingress configuration for the Container App                                                                                                                                                                                                                                                                                                     | <pre>object({<br/> allow_insecure_connections = optional(bool)<br/> external_enabled = optional(bool)<br/> fqdn = optional(string)<br/> exposed_port = optional(number)<br/> target_port = number<br/> transport = string<br/> traffic_weight = list(object({<br/> label = optional(string)<br/> latest_revision = optional(bool, false)<br/> revision_suffix = optional(string)<br/> percentage = number<br/> }))<br/> ip_security_restriction = optional(list(object({<br/> action = string<br/> description = optional(string)<br/> ip_address_range = string<br/> name = string<br/> })), [])<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`  |    no    |
| <a name="input_location"></a> [location](#input_location)                                                             | Specifies the supported Azure location where the resource exists. Changing this forces a new resource to be created                                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_max_inactive_revisions"></a> [max_inactive_revisions](#input_max_inactive_revisions)                   | The maximum of inactive revisions allowed for this Container App                                                                                                                                                                                                                                                                                | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `null`  |    no    |
| <a name="input_name"></a> [name](#input_name)                                                                         | The name of the Container Apps Managed Environment. Changing this forces a new resource to be created                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_registry"></a> [registry](#input_registry)                                                             | Container registry connection and authentication configuration for the Container App                                                                                                                                                                                                                                                            | <pre>object({<br/> server = string<br/> identity = optional(string)<br/> password_secret_name = optional(string)<br/> username = optional(string)<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`  |    no    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name)                            | Name of the resource group that the Container App Environment should be in. Should be in the format of: `rg-foo`                                                                                                                                                                                                                                | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_revision_mode"></a> [revision_mode](#input_revision_mode)                                              | The revisions operational mode for the Container App. Possible values include Single and Multiple. In Single mode, a single revision is in operation at any given time. In Multiple mode, more than one revision can be active at a time and can be configured with load distribution via the traffic_weight block in the ingress configuration | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_secret"></a> [secret](#input_secret)                                                                   | Secrets configuration for the Container App                                                                                                                                                                                                                                                                                                     | <pre>object({<br/> name = string<br/> identity = optional(string)<br/> key_vault_secret_id = optional(string)<br/> value = optional(string)<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `null`  |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                         | A mapping of tags to assign to the resource                                                                                                                                                                                                                                                                                                     | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `{}`    |    no    |
| <a name="input_template"></a> [template](#input_template)                                                             | Template configuration for the Container App                                                                                                                                                                                                                                                                                                    | <pre>object({<br/> min_replicas = optional(number, 0)<br/> max_replicas = optional(number, 10)<br/> revision_suffix = optional(string)<br/> container = list(object({<br/> name = string<br/> image = string<br/> cpu = optional(number, 0.25)<br/> memory = optional(string, "0.5Gi")<br/> args = optional(list(string), [])<br/> command = optional(list(string), [])<br/> env = optional(list(object({<br/> name = string<br/> secret_name = optional(string)<br/> value = optional(string)<br/> })), [])<br/> liveness_probe = optional(object({<br/> port = number<br/> transport = string<br/> failure_count_threshold = optional(number, 3)<br/> host = optional(string)<br/> initial_delay = optional(number, 1)<br/> interval_seconds = optional(number, 10)<br/> path = optional(string)<br/> termination_grace_period_seconds = optional(number)<br/> timeout = optional(number, 1)<br/> header = optional(map(string))<br/> }))<br/> startup_probe = optional(object({<br/> port = number<br/> transport = string<br/> failure_count_threshold = optional(number, 3)<br/> host = optional(string)<br/> initial_delay = optional(number, 0)<br/> interval_seconds = optional(number, 10)<br/> path = optional(string)<br/> termination_grace_period_seconds = optional(number)<br/> timeout = optional(number, 1)<br/> header = optional(map(string))<br/> }))<br/> readiness_probe = optional(object({<br/> port = number<br/> transport = string<br/> failure_count_threshold = optional(number, 3)<br/> host = optional(string)<br/> initial_delay = optional(number, 0)<br/> interval_seconds = optional(number, 10)<br/> path = optional(string)<br/> sucess_count_threshold = optional(number, 3)<br/> timeout = optional(number, 1)<br/> header = optional(map(string))<br/> }))<br/> }))<br/> http_scale_rule = optional(list(object({<br/> name = string<br/> concurrent_requests = number<br/> authentication = optional(list(object({<br/> secret_name = string<br/> trigger_parameter = string<br/> })), [])<br/> })), [])<br/> tcp_scale_rule = optional(list(object({<br/> name = string<br/> concurrent_requests = number<br/> authentication = optional(list(object({<br/> secret_name = string<br/> trigger_parameter = string<br/> })), [])<br/> })), [])<br/> custom_scale_rule = optional(list(object({<br/> name = string<br/> custom_rule_type = string<br/> metadata = map(string)<br/> authentication = optional(list(object({<br/> secret_name = string<br/> trigger_parameter = string<br/> })), [])<br/> })), [])<br/> })</pre> | n/a     |   yes    |
| <a name="input_workload_profile_name"></a> [workload_profile_name](#input_workload_profile_name)                      | The name of the Workload Profile in the Container App Environment to place this Container App                                                                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `null`  |    no    |

## Outputs

| Name                                                                                            | Description                                          |
| ----------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| <a name="output_id"></a> [id](#output_id)                                                       | The ID of the Container App                          |
| <a name="output_ingress_debug"></a> [ingress_debug](#output_ingress_debug)                      | n/a                                                  |
| <a name="output_latest_revision_fqdn"></a> [latest_revision_fqdn](#output_latest_revision_fqdn) | The FQDN of the latest revision of the Container App |
| <a name="output_latest_revision_name"></a> [latest_revision_name](#output_latest_revision_name) | The name of the latest Container Revision            |

<!-- END_TF_DOCS -->
