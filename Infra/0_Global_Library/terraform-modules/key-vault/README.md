<!-- BEGIN_TF_DOCS -->

## Requirements

No requirements.

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azuread"></a> [azuread](#provider_azuread) | n/a     |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | n/a     |

## Modules

| Name                                                                                | Source              | Version |
| ----------------------------------------------------------------------------------- | ------------------- | ------- |
| <a name="module_common_constants"></a> [common_constants](#module_common_constants) | ../common/constants | n/a     |

## Resources

| Name                                                                                                                                                              | Type        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [azuread_application.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/application)                                           | resource    |
| [azuread_group.kv_admin](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group)                                                   | resource    |
| [azuread_group.kv_reader](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group)                                                  | resource    |
| [azuread_service_principal.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/service_principal)                               | resource    |
| [azurerm_key_vault.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault)                                               | resource    |
| [azurerm_management_lock.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/management_lock)                                   | resource    |
| [azurerm_pim_eligible_role_assignment.pim_kv_admin](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/pim_eligible_role_assignment) | resource    |
| [azurerm_role_assignment.rbac_kv_admin](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment)                          | resource    |
| [azurerm_role_assignment.rbac_kv_reader](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment)                         | resource    |
| [azurerm_role_assignment.rbac_kv_secrets_user](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment)                   | resource    |
| [azuread_client_config.current](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/data-sources/client_config)                                 | data source |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config)                                 | data source |
| [azurerm_role_definition.kv_admin](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/role_definition)                            | data source |

## Inputs

| Name                                                                                                                           | Description                                                                                                                                                                                                                                    | Type                                                                                                                                                                                                    | Default      | Required |
| ------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ | :------: |
| <a name="input_administrative_unit_ids"></a> [administrative_unit_ids](#input_administrative_unit_ids)                         | administrative unit ID for the Key Vault access groups                                                                                                                                                                                         | `set(string)`                                                                                                                                                                                           | `[]`         |    no    |
| <a name="input_create_service_principal"></a> [create_service_principal](#input_create_service_principal)                      | Boolean to control the creation of an Entra ID service principal if an intermediate identity is needed for authenticating to the Key Vault.                                                                                                    | `bool`                                                                                                                                                                                                  | `false`      |    no    |
| <a name="input_enabled_for_deployment"></a> [enabled_for_deployment](#input_enabled_for_deployment)                            | Whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the Key Vault.                                                                                                                                    | `bool`                                                                                                                                                                                                  | `false`      |    no    |
| <a name="input_enabled_for_disk_encryption"></a> [enabled_for_disk_encryption](#input_enabled_for_disk_encryption)             | Whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys.                                                                                                                                                 | `bool`                                                                                                                                                                                                  | `false`      |    no    |
| <a name="input_enabled_for_template_deployment"></a> [enabled_for_template_deployment](#input_enabled_for_template_deployment) | Whether Azure Resource Manager is permitted to retrieve secrets from the Key Vault.                                                                                                                                                            | `bool`                                                                                                                                                                                                  | `false`      |    no    |
| <a name="input_environment"></a> [environment](#input_environment)                                                             | Environment shortname                                                                                                                                                                                                                          | `string`                                                                                                                                                                                                | n/a          |   yes    |
| <a name="input_kv_reader_member_object_ids"></a> [kv_reader_member_object_ids](#input_kv_reader_member_object_ids)             | User object IDs to be added to the kv_reader group. Note if deploying a service principal, it will be automatically added.                                                                                                                     | `list(string)`                                                                                                                                                                                          | `[]`         |    no    |
| <a name="input_location"></a> [location](#input_location)                                                                      | Azure region short name (CAF). e.g. `eus` for East US. See: https://www.jlaundry.nz/2022/azure_region_abbreviations/                                                                                                                           | `string`                                                                                                                                                                                                | n/a          |   yes    |
| <a name="input_lock"></a> [lock](#input_lock)                                                                                  | The lock level to apply to the Key Vault. Default is `None`. Possible values are `None`, `CanNotDelete`, and `ReadOnly`.                                                                                                                       | <pre>object({<br/> kind = string<br/> name = optional(string, null)<br/> })</pre>                                                                                                                       | `null`       |    no    |
| <a name="input_name"></a> [name](#input_name)                                                                                  | A name describing what the key vault is for. Note that the real name of the resource will have the location and the environment appended to it. The provided name should be all lowercase and one word. e.g. `avd` (for Azure Virtual Desktop) | `string`                                                                                                                                                                                                | n/a          |   yes    |
| <a name="input_network_acls"></a> [network_acls](#input_network_acls)                                                          | Object with attributes: bypass, default_action, ip_rules, virtual_network_subnet_ids. Set to null to disable. See https://www.terraform.io/docs/providers/azurerm/r/key_vault.html#bypass for more information.                                | <pre>list(object({<br/> bypass = optional(string)<br/> default_action = optional(string)<br/> ip_rules = optional(list(string))<br/> virtual_network_subnet_ids = optional(list(string))<br/> }))</pre> | `[]`         |    no    |
| <a name="input_pim_assignments"></a> [pim_assignments](#input_pim_assignments)                                                 | Object IDs of users who require Key Vault Reader/Secrets User and/or Key Vault Administrator assigned through PIM.                                                                                                                             | <pre>object({<br/> kv_admin_pim_eligible_object_ids = optional(list(string))<br/> })</pre>                                                                                                              | `{}`         |    no    |
| <a name="input_pim_eligibility_duration_days"></a> [pim_eligibility_duration_days](#input_pim_eligibility_duration_days)       | Duration in days for the PIM eligibility assignment. Defaults to 365 days. Depends on pim_assignments being not null or empty                                                                                                                  | `number`                                                                                                                                                                                                | `365`        |    no    |
| <a name="input_public_network_access_enabled"></a> [public_network_access_enabled](#input_public_network_access_enabled)       | Whether the Key Vault is available from public network.                                                                                                                                                                                        | `bool`                                                                                                                                                                                                  | `false`      |    no    |
| <a name="input_purge_protection_enabled"></a> [purge_protection_enabled](#input_purge_protection_enabled)                      | Whether to activate purge protection.                                                                                                                                                                                                          | `bool`                                                                                                                                                                                                  | `true`       |    no    |
| <a name="input_rbac_authorization_enabled"></a> [rbac_authorization_enabled](#input_rbac_authorization_enabled)                | Whether the Key Vault uses Role Based Access Control (RBAC) for authorization of data actions instead of access policies.                                                                                                                      | `bool`                                                                                                                                                                                                  | `true`       |    no    |
| <a name="input_resource_group"></a> [resource_group](#input_resource_group)                                                    | Name of the resource group that the key vault should be in. Should be in the format of: `rg-foo`                                                                                                                                               | `string`                                                                                                                                                                                                | n/a          |   yes    |
| <a name="input_sku_name"></a> [sku_name](#input_sku_name)                                                                      | The Name of the SKU used for this key vault. Possible values are standard and premium.                                                                                                                                                         | `string`                                                                                                                                                                                                | `"standard"` |    no    |
| <a name="input_soft_delete_retention_days"></a> [soft_delete_retention_days](#input_soft_delete_retention_days)                | The number of days that items should be retained for once soft-deleted. This value can be between `7` and `90` days.                                                                                                                           | `number`                                                                                                                                                                                                | `90`         |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                                  | Tags for the deployment. Tag names are case insensitive, but tag values are case sensitive. The `managedBy = "terraform"` tag will automatically be applied in addition to any other tags specified.                                           | `map(string)`                                                                                                                                                                                           | `{}`         |    no    |
| <a name="input_tenant_id"></a> [tenant_id](#input_tenant_id)                                                                   | If no value is provided the default tenant_id will be the current tenant of the deployment principal.                                                                                                                                          | `string`                                                                                                                                                                                                | `""`         |    no    |

## Outputs

| Name                                            | Description                  |
| ----------------------------------------------- | ---------------------------- |
| <a name="output_id"></a> [id](#output_id)       | Resource ID of the Key Vault |
| <a name="output_name"></a> [name](#output_name) | Name of the Key Vault        |

<!-- END_TF_DOCS -->

## Permissions Required

Full usage of this module requires the following roles. If no RBAC or role assignments are necessary the permissions are not needed.

- `Key Vault Data Access Administrator`: Required over the scope of the Key Vault resource for RBAC and PIM role assignments.
- `Group.ReadWrite.All` Graph API permission for the deployment service principal to create the Azure AD Groups
- `Application.ReadWrite.OwnedBy`: Required if `Create_Service_Principal` is set to true. To create the intermediary service principal for usage by on-premise workloads.
