<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >=1.9.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >=4.2.0 |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | >=4.2.0 |

## Modules

| Name                                                                                | Source              | Version |
| ----------------------------------------------------------------------------------- | ------------------- | ------- |
| <a name="module_common_constants"></a> [common_constants](#module_common_constants) | ../common/constants | n/a     |

## Resources

| Name                                                                                                                                                                              | Type     |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_monitor_data_collection_rule.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_data_collection_rule)                         | resource |
| [azurerm_monitor_data_collection_rule_association.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_data_collection_rule_association) | resource |

## Inputs

| Name                                                                                                               | Description                                                                                                                                                                                                                                                                                               | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Default | Required |
| ------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | :------: |
| <a name="input_associations"></a> [associations](#input_associations)                                              | Data Collection Rule Resource associations. These are the target resource IDs where the rules will be applied.                                                                                                                                                                                            | <pre>list(object({<br> name = optional(string, "configurationAccessEndpoint")<br> target_resource_id = string<br> data_collection_rule_id = optional(string)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `[]`    |    no    |
| <a name="input_collection_rules"></a> [collection_rules](#input_collection_rules)                                  | Configuration of rules containing data_source, destination and data_flows to compose a complete data collection rule. Data_Sources can be omitted if the rule is meant to be used via direct calls to the provisioned endpoint.                                                                           | <pre>list(object({<br> data_sources = optional(object({<br> windows_event_log = optional(object({<br> name = optional(string)<br> streams = list(string)<br> x_path_queries = list(string)<br> }))<br> iis_log = optional(object({<br> name = optional(string)<br> streams = list(string)<br> log_directories = list(string)<br> }))<br> syslog = optional(object({<br> name = optional(string)<br> facility_names = list(string) # can be one or many of: "alert" "\*" "audit" "auth" "authpriv" "clock" "cron" "daemon" "ftp" "kern" "local5" "local4" "local1" "local7" "local6" "local3" "local2" "local0" "lpr" "mail" "mark" "news" "nopri" "ntp" "syslog" "user" "uucp"<br> log_levels = list(string)<br> streams = list(string)<br> }))<br> log_file = optional(object({<br> name = optional(string)<br> format = string<br> file_patterns = list(string)<br> streams = list(string)<br> record_start_timestamp_format = string<br> }))<br> performance_counter = optional(object({<br> name = optional(string)<br> streams = list(string)<br> scheduled_transfer_period = string<br> sampling_frequency_in_seconds = number<br> counter_specifiers = list(string)<br> }))<br> extension = optional(list(object({<br> name = optional(string)<br> extension_name = string<br> extension_json = string<br> })))<br> }))<br> data_flow = object({<br> streams = list(string)<br> destinations = list(string)<br> built_in_transform = optional(string)<br> output_stream = optional(string)<br> transform_kql = optional(string)<br> })<br> destinations = object({<br> log_analytics = optional(object({<br> workspace_resource_id = string<br> name = string<br> }))<br> azure_monitor_metrics = optional(object({<br> name = string<br> }))<br> })<br> }))</pre> | n/a     |   yes    |
| <a name="input_data_collection_endpoint_id"></a> [data_collection_endpoint_id](#input_data_collection_endpoint_id) | The resource ID of the Data Collection Endpoint that this rule will be associated to. Required for IIS_Logs, Firewall Logs, Text Logs, Custom Logs, Prometheus Metrics.                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`  |    no    |
| <a name="input_environment"></a> [environment](#input_environment)                                                 | Environment shortname                                                                                                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a     |   yes    |
| <a name="input_identity"></a> [identity](#input_identity)                                                          | Managed identity configuration.                                                                                                                                                                                                                                                                           | <pre>list(object({<br> type = string # Specifies the type of Managed Service Identity that should be configured on this Data Collection Rule. Possible values are `SystemAssigned` and `UserAssigned`.<br> identity_ids = optional(set(string)) # Required when `Type` is set to `UserAssigned`. A list of User Assigned Managed Identity IDs to be assigned to this Data Collection Rule. Currently, up to 1 identity is supported.<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`    |    no    |
| <a name="input_kind"></a> [kind](#input_kind)                                                                      | The kind of the Data Collection Rule. Possible values are Linux, Windows, AgentDirectToStore and WorkspaceTransforms. Kind Linux does not allow for windows_event_log data sources. Kind Windows does not allow for syslog data sources. If kind is not specified, all kinds of data sources are allowed. | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`  |    no    |
| <a name="input_location"></a> [location](#input_location)                                                          | Azure region short name (CAF). e.g. `eus` for East US. See: https://www.jlaundry.nz/2022/azure_region_abbreviations/                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a     |   yes    |
| <a name="input_name"></a> [name](#input_name)                                                                      | A name describing what the data collection rule is for. Note that the real name of the resource will have the location and the environment appended to it. The provided name should be all lowercase and one word. e.g. `avd` (for Azure Virtual Desktop)                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a     |   yes    |
| <a name="input_resource_group"></a> [resource_group](#input_resource_group)                                        | Name of the resource group that the data collection rule should be in. Should be in the format of: `rg-foo`                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a     |   yes    |
| <a name="input_stream_declaration"></a> [stream_declaration](#input_stream_declaration)                            | Stream declaration of custom tables and columns                                                                                                                                                                                                                                                           | <pre>list(object({<br> stream_name = string # The name of the custom stream. This name should be unique across all stream_declaration blocks and must begin with a prefix of `Custom-`<br> columns = list(object({<br> name = string<br> type = string<br> }))<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `[]`    |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                      | Tags for the deployment. Tag names are case insensitive, but tag values are case sensitive. The `managedBy = "terraform"` tag will automatically be applied in addition to any other tags specified.                                                                                                      | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `{}`    |    no    |

## Outputs

| Name                                                                                                           | Description                                  |
| -------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| <a name="output_data_collection_rule_id"></a> [data_collection_rule_id](#output_data_collection_rule_id)       | The resource ID of the data collection rule. |
| <a name="output_data_collection_rule_name"></a> [data_collection_rule_name](#output_data_collection_rule_name) | The name of the data collection rule.        |

<!-- END_TF_DOCS -->

## Module Planning Notes and general tips:

A data collection rule (DCR) can have many data sources: Windows Event Logs, Performance Counters, Linux Syslog, IIS Logs, Custom Text and JSON Logs, Prometheus Metrics.

- Only one of each data source type is allowed per rule. Therefore module iteration (for_each) should be at the Data Source level.
- Every data source can have a different destination. However, we're going to adhere to one Log Analytics workspace per DCR. We don't have any need for more than one and don't forsee it being a future need.
- Linux Syslog, IIS Logs, Custom Text and JSON Logs, Prometheus Metrics requires a Data Collection Endpoint (DEP). This module should support the creation of a new DEP or usage of an existing DEP.
- The Data Collection rule structure documentation is a good read into proper DCR construction: https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-rule-structure

## Syslog accepted facility name values:

"alert" "\*" "audit" "auth" "authpriv" "clock" "cron" "daemon" "ftp" "kern" "local5" "local4" "local1" "local7" "local6" "local3" "local2" "local0" "lpr" "mail" "mark" "news" "nopri" "ntp" "syslog" "user" "uucp"
